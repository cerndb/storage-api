stages:
 - test
 - build
 - deploy

perform-tests:
  stage: test
  image: python:3
  before_script:
    - pip install -r requirements.txt
    - python setup.py install
    - pip install coveralls
  script:
    - make test
    - coveralls


build-docker-image:
  stage: build
  tags:
   - docker-image-build
  script: "echo building $CI_REGISTRY_IMAGE:runner" # No empty scripts are allowed
  variables:
   TO: $CI_REGISTRY_IMAGE:runner # Where to push resulting image

deploy-openshift:
  allow_failure: true
  stage: deploy
  image: gitlab-registry.cern.ch/paas-tools/openshift-client:latest
  script: "oc import-image $IMAGE_NAME  --server=$OPENSHIFT_SERVER --token=$IMAGE_IMPORT_TOKEN --namespace $OPENSHIFT_PROJECT_NAME"

build-doc:
  image: python:3
  artifacts:
    paths:
      - doc/html
  stage: build
  before_script:
    - apt-get update && apt-get install -y nodejs npm
    - pip install -r requirements.txt
    - python setup.py install
    - npm install -g spectacle-docs
  script:
    - make html
    - make doc_deploy

deploy-doc:
  stage: deploy
  image: gitlab-registry.cern.ch/ci-tools/ci-web-deployer:latest
  script:
    - deploy-dfs


lint:
  image: python:3
  stage: test
  allow_failure: true
  before_script:
    - pip install flake8

  script:
    - make lint
