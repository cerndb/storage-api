

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>CERN Unified Storage API &mdash; CERN Unified Storage API 2.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="CERN Unified Storage API 2.0.1 documentation" href="index.html"/>
        <link rel="next" title="storage-api" href="source/modules.html"/>
        <link rel="prev" title="CERN Unified Storage API documentation" href="index.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> CERN Unified Storage API
          

          
          </a>

          
            
            
              <div class="version">
                2.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">CERN Unified Storage API README</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#aim-of-the-project">Aim of the project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#components-and-design">Components and Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="#development">Development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuration">Configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#testing-and-continuous-integration">Testing and Continuous Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deployment">Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="./api/index.html#http://">API Documentation (generated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="source/modules.html">Source Documentation (generated)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">CERN Unified Storage API</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>CERN Unified Storage API</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cern-unified-storage-api">
<span id="cern-unified-storage-api"></span><h1>CERN Unified Storage API<a class="headerlink" href="#cern-unified-storage-api" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://travis-ci.org/cerndb/storage-api"><img alt="Build Status" src="https://travis-ci.org/cerndb/storage-api.svg?branch=master" /></a>
<a class="reference external" href="https://coveralls.io/github/cerndb/storage-api?branch=master"><img alt="Coverage Status" src="https://coveralls.io/repos/github/cerndb/storage-api/badge.svg?branch=master" /></a></p>
<div class="section" id="aim-of-the-project">
<span id="aim-of-the-project"></span><h2>Aim of the project<a class="headerlink" href="#aim-of-the-project" title="Permalink to this headline">¶</a></h2>
<p>IT DB Storage team is facing the need to work with different storage
providers in order to deliver different storage solutions that should
adapt to different projects needs. So far, a library and a set of
scripts has been developed to interact mainly with NetApp storage.  The
actual solution presents a RESTful API developed using Flask and
Python 3.</p>
</div>
<div class="section" id="usage">
<span id="usage"></span><h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>Accessing <code class="docutils literal"><span class="pre">/login</span></code> will put you through the standard CERN single sign-on
process and return you to the API with an authenticated session once you
are done. For use in Python scripts and applications, setting the
relevant session cookies using
<a class="reference external" href="https://gitlab.cern.ch/db/cern-sso-python">cern-sso-python</a> is
recommended.</p>
<p>For API documentation, see the generated Swagger documentation (linked below).</p>
</div>
<div class="section" id="components-and-design">
<span id="components-and-design"></span><h2>Components and Design<a class="headerlink" href="#components-and-design" title="Permalink to this headline">¶</a></h2>
<p>The Storage API uses the flask-sso module developed by
<a class="reference external" href="https://github.com/inveniosoftware/flask-sso">Invenio</a>. Authorisation
is based on CERN e-groups (Active Directory distribution lists), and
user authentication is done using the central OAuth2 providers.</p>
<p>The application is designed around common Python and Flask framework
patterns, with some help from the flask-restplus framework to provide
boilerplate REST code. A factory pattern is used to mount the same APIs
mapped to different back-ends as Flask paths. Back-ends are implemented
as Flask extensions and modelled using an
<a class="reference external" href="https://pymotw.com/2/abc/">abstract base class</a>, and resolved at
run-time. This way, the API allows for successive implementations of
future back-ends on the same API.</p>
</div>
<div class="section" id="development">
<span id="development"></span><h2>Development<a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h2>
<p>Development and testing (without proper authentication) can be done
without a full deployment setup (see below). You need Python 3 and
virtualenv (on Ubuntu <code class="docutils literal"><span class="pre">python3-virtualenv</span></code>) installed before running the
commands below.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">cerndb</span><span class="o">/</span><span class="n">storage</span><span class="o">-</span><span class="n">api</span>
<span class="n">cd</span> <span class="n">storage</span><span class="o">-</span><span class="n">api</span>
<span class="n">virtualenv</span> <span class="o">--</span><span class="n">python</span><span class="o">=</span><span class="n">python3</span> <span class="n">v1</span>
<span class="n">source</span> <span class="o">.</span><span class="n">v1</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>You can run the API in the Flask development server without SSO like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ export FLASK_APP=app.py
$ export FLASK_DEBUG=1
$ flask run
</pre></div>
</div>
<p>Accessing <code class="docutils literal"><span class="pre">/login</span></code> in debug mode <em>will immediately authorise you as an
uber-admin</em>.</p>
<p>There is also a shorthand Makefile option available as <code class="docutils literal"><span class="pre">make</span> <span class="pre">devserver</span></code>
with corresponding <code class="docutils literal"><span class="pre">make</span> <span class="pre">stop</span></code>.</p>
<p>It is also possible to run the Dockerised image with <code class="docutils literal"><span class="pre">make</span> <span class="pre">image</span> <span class="pre">run</span></code>.
Remember that you can determine which random port the container
was assigned with <code class="docutils literal"><span class="pre">docker</span> <span class="pre">port</span> <span class="pre">&lt;name</span> <span class="pre">of</span> <span class="pre">container&gt;</span></code>.</p>
<div class="section" id="configuration">
<span id="configuration"></span><h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Configuration is done using environment variables, as per the 12-factor
app pattern. The following environment variables are used:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_CLIENT_ID</span></code>: The public client ID for the OAuth2 service
the storage API runs as</li>
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_SECRET_KEY</span></code>: The private key of the OAuth2 service the
storage API runs as</li>
</ul>
<p>The following keys are optional:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_TOKEN_URL</span></code>: The URL to get OAuth2 Tokens from. <strong>Default</strong>:
<code class="docutils literal"><span class="pre">https://oauth.web.cern.ch/OAuth/Token</span></code></li>
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_AUTHORIZE_URL</span></code>: The URL to send OAuth2 Authorization
requests to. <strong>Default</strong>: <code class="docutils literal"><span class="pre">https://oauth.web.cern.ch/OAuth/Authorize</span></code></li>
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_GROUPS_URL</span></code>: The URL to send a GET request with the
current OAuth2 token to receive a list of groups the current user is a
member of. <strong>Default</strong>: <code class="docutils literal"><span class="pre">https://oauthresource.web.cern.ch/api/Groups</span></code></li>
<li><code class="docutils literal"><span class="pre">SAPI_OAUTH_CALLBACK_URL_RELATIVE</span></code>: The relative (to the app&#8217;s root)
URL to report as the call-back URL to the OAuth2 Authorize server. You
most likely do not need to change this, unless you have some really
exotic routing pattern. <strong>Default</strong>: <code class="docutils literal"><span class="pre">/oauth-done</span></code></li>
</ul>
<p>The following configuration options control the role-based access control:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">SAPI_ROLE_USER_GROUPS</span></code>: A comma-separated list of groups whose users
are just plain users. If the list is empty or unset, unauthenticated
users are included in the user role and given access to certain
(non-destructive) endpoints. See the API documentation!</li>
<li><code class="docutils literal"><span class="pre">SAPI_ROLE_ADMIN_GROUPS</span></code>: A comma-separated list of groups whose users
are (at least) administrators. Empty list or unset variable means
the role is disabled.</li>
<li><code class="docutils literal"><span class="pre">SAPI_ROLE_UBER_ADMIN_GROUPS</span></code>: A comma-separated list of groups whose
users are uber-admins. Empty list
or unset variable means the role is disabled.</li>
</ul>
<p>Please note that roles are distinct, e.g. the admin role is not
contained within the uber-admin-role. If you want both, you need to have
both.</p>
<p>Back-ends are configured using the following pattern:</p>
<ul>
<li><p class="first"><code class="docutils literal"><span class="pre">SAPI_BACKENDS</span></code>: A unicorn emoji-separated (:unicorn:) list of back-ends to enable,
and their configuration as per the following pattern:
<code class="docutils literal"><span class="pre">endpoint_name:BackEndClass:option_name:option_value:another_option_name:another_option_value</span></code>,
where endpoint_name is the part that goes into the
<code class="docutils literal"><span class="pre">/&lt;endpoint_name&gt;/volumes&gt;</span></code> part of the URL, <code class="docutils literal"><span class="pre">BackEndClass</span></code> is the
name of a class that implements the corresponding back-end
(e.g. <code class="docutils literal"><span class="pre">DummyStorage</span></code>), and the following set of rainbow emoji-separated
options (:rainbow:) will be passed as keys and value arguments to that back-ends
constructor.</p>
<p>The following example sets up a NetApp back-end and RAM-backed dummy back-end:
<code class="docutils literal"><span class="pre">export</span> <span class="pre">SAPI_BACKENDS=&quot;dummy🌈DummyStorage🦄netapp🌈NetappStorage🌈username🌈storage-api🌈password🌈myPassword:&#64;;🌈vserver🌈vs3sx50&quot;</span></code></p>
<p>Please note that it is perfectly possible to set up multiple endpoints
with the same back-end, e.g. multiple NetApp filers or clusters with
different vservers on different endpoints. Endpoints needs to be
unique though.</p>
</li>
</ul>
<p><strong>Without at least one configured endpoint, the app will not run.</strong></p>
</div>
</div>
<div class="section" id="testing-and-continuous-integration">
<span id="testing-and-continuous-integration"></span><h2>Testing and Continuous Integration<a class="headerlink" href="#testing-and-continuous-integration" title="Permalink to this headline">¶</a></h2>
<p>Continuous integration is provided by Travis, and tests are run using
py.test and the Hypothesis framework. A more exhaustive Hypothesis test
run takes a while to run (around 10-15 minutes), so it is advised to use
the much less exhaustive &#8220;dev&#8221; test profile and leave the &#8220;ci&#8221; profile
for Travis. The profile can be provided as a command-line option for
pytest: <code class="docutils literal"><span class="pre">pytest</span> <span class="pre">--hypothesis-profile=dev</span></code>. Logging verbosity during
tests can be increased using <code class="docutils literal"><span class="pre">-vvvv</span></code> with a variable number of <code class="docutils literal"><span class="pre">v</span></code>:s
(more is noisier).</p>
</div>
<div class="section" id="deployment">
<span id="deployment"></span><h2>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h2>
<p>The API is deployed via a standard Docker container to
OpenShift. Provided you are authenticated with CERN&#8217;s GitLab as a
registry in Docker, running <code class="docutils literal"><span class="pre">make</span> <span class="pre">image</span> <span class="pre">push-image</span></code> will compile the
image and push it to the registry. If you have also set
<code class="docutils literal"><span class="pre">OPENSHIFT_PUSH_TOKEN</span></code> to an authentication token with access to pushing
images to the the OpenShift project, <code class="docutils literal"><span class="pre">make</span> <span class="pre">deploy-os</span></code> will finally
deploy the new image to OpenShift as a rolling deployment. The entire
process can be run with <code class="docutils literal"><span class="pre">make</span> <span class="pre">image</span> <span class="pre">push-image</span> <span class="pre">deploy-os</span></code>.</p>
</div>
<div class="section" id="documentation">
<span id="documentation"></span><h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>An interactive API Documentation is automatically generated by
flask-restplus and served at the path <code class="docutils literal"><span class="pre">/</span></code>, with a JSON description
available at <code class="docutils literal"><span class="pre">/swagger.json</span></code>. A HTML version is also rendered by
<a class="reference external" href="http://sourcey.com/spectacle/">Spectacle</a> and published automatically
by Travis to
<a class="reference external" href="http://cerndb.github.io/storage-api/">cerndb.github.io/storage-api</a>.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="source/modules.html" class="btn btn-neutral float-right" title="storage-api" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="CERN Unified Storage API documentation" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, CERN.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>